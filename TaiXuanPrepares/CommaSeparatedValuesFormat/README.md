# Comma Separated Values Format

首先考虑一个小问题——“表格”一词表示什么意思？

我认为通常被我们称为“表格”的东西，实际上包含了两种具有不同目的的东西。第一种是我们论文中，杂志上常见的“图表”中的“表”。这种表格的作用主要是向读者展示数据。因而这种表是面向人的，你除了要保证表格内容正确，还应当保证表格对于人来说是易读的，甚至美观的。这种表和流程示意图是同一类东西。

第二种是我们在做数据处理时，用作数据结构的“表格”。这种表格不是直接拿来给人看的，而是用于存储和处理大量同构数据的。对于这种表格来说，严格的格式定义要比它看起来怎么样重要得多。这种表和数据结构中的树是同一类东西。可以说这种表是“面向算法”的。

这两种表当然是可以相互转化的。你可以根据数据库中的表示生成展示性的表格，也可以把展示性表格中的数据提取出来存储到数据库中。不过对于今天我们要讨论的话题来说，把两种表的区别厘清还是很有必要的。

今天要介绍的CSV文件格式，属于上边所说的第二类表格。也就是说它是用于数据处理中的表格，而非展示性的表格。你不会想用它在论文中展示实验结果或者在工作汇报中展示本周业绩。

更准确地说，CSV文件格式是专注于数据工作中，存储数据这个环节的一种格式（也就是说读入内存进行运算时，表格不再是CSV格式）。而且是存储同构数据的格式（异构数据考虑用JSON之类的格式存储）。

> CSV是数据处理中的表格，而非展示性的表格。但是这并不意味着人看不懂CSV文件。只是相比起各种PPT上那种能让人一眼Get到关键信息的表格来说，CSV原本的显示方式不是很容易读，而且没有刻意突出表中的某些信息。

弄清楚CSV的定位，很多莫名其妙的问题自然就有了答案。例如：

问：CSV和JSON有什么优劣？

答：一个存同构，一个存异构，怎么比较？

问：CSV和数据库比有什么优劣？

答：CSV只关注表格数据存储这一个环节。而数据库是一个把数据从生管到死的完整系统。CSV可以作为数据库方案的一部分，但是并不是所有数据库方案都采用CSV作为其一部分。因此二者根本不是同级别同类型的对象，无法比较。

问：CSV和Excel比哪个好？

答：Excel能编辑CSV你信么？Excel是一个编辑表格的软件，CSV是一个文件格式。根本无从比较。能比较的应该是MS Office Excel默认保存的Office Open XML Workbook文件格式（后缀为`.xlsx`）和CSV文件格式。

## 逗号分隔值格式

CSV全称Comma Separated Values，字面直译“逗号分隔值”。所以“CSV文件”完全用汉字写就是“逗号分隔值文件”。而“CSV Format”就应该翻译为“逗号分隔值格式”。

这种文件格式的出发点十分朴素——普通的纯文本只有“行”而没有“列”，CSV约定用逗号（注意是英文逗号）表示列间隔，这样有“行”有“列”就能表示表格了。

所以一个简单的表格应该是这样：

```csv
太玄,Up主,咕咕咕
一天世界君,Up主,咕咕咕
酒石酸,Up主,更新中
斗地主之王,观众,吃瓜
```

是不是看起来缺点什么？没错缺个表头来说明每一列数据的含义。CSV为此并没有约定特别的语法，如果你想加个表头，把第一行当作表头写就行了（记住这个坑爹设定）。

加上表头之后就是：

```csv
名称,身份,状态
太玄,Up主,咕咕咕
一天世界君,Up主,咕咕咕
酒石酸,Up主,更新中
斗地主之王,观众,吃瓜
```

现在再考虑一个问题，如果我某一单元格的值中正好包含英文逗号本身该怎么办？

聪明的你一定想到了转义字符。在CSV中约定了一种现在看起来比较奇怪的转义机制——一对双引号内的内容被认为是原样字符串。也就是说如果要在一个单元格内部包含逗号或者换行，只需要直接写上逗号或者换行，然后把这个单元格内容用一对双引号（英文双引号）括起来。

那么要让单元格中包含双引号本身怎么办呢？首先你要用双引号把这个单元格括起来，然后在双引号内部连续使用两个双引号来表示一个双引号。这里是一个例子：

```csv
序号,内容
1,一条普通的记录
2,"另一条不会显示引号的普通的记录"
3,"一条,带有逗号的记录"
4,"一条
带有换行的记录"
5,"一条带有一对""引号""的记录"
```

虽然这个转义机制有些怪异，但现在一切看起来都挺好。可实际上这个简单的文件格式隐藏了巨大的混乱。

## 某分隔值格式

用逗号作为分隔符在一些应用情境下，会有很多问题。例如用一些自然语言语句作为单元格内容的时候，会在单元格内出现很多逗号。有的欧洲国家还会在写数字的时候加入很多逗号。这些情况下都要频繁使用转义机制。这就严重影响了CSV文件的可读性（对人来说）和人工书写难度。

因此在那个Excel等工具还不像今天这么普及的时代，人们就试图通过修改CSV语法来解决问题。比如用其他符号替代逗号作为列分隔符。一种用得比较广的替代方案就是用HT[^1]来替代逗号，称为TSV（Tab Separated Values）。

> TSV文件的后缀名也和CSV不同。CSV文件的后缀一般为`.csv`，而TSV的后缀一般为`.tsv`。

但是除了TSV，还有各种千奇百怪的替代方案。由于这些不同方案对于CSV解析的影响仅限于换了一个分隔符，所以很多CSV解析引擎干脆把定义分隔符的权利让给用户，由用户指定按照什么分隔符分隔列表。这样，虽然我们一般还叫这类文件为CSV文件，可这些文件中使用的却不一定是逗号分隔符。

## 更多混乱和混乱中的秩序

CSV文件其实有一个标准文件，这就是RFC 4180。但是这个标准文件并没有起到很好的规范用法的作用，反而因为一些现在看来莫名其妙的设定实质上加剧了CSV格式的混乱。因为它规定使用CRLF[^2][^3]作为行分隔符，而非类Unix系统中通用的LF[^3]。

除了行列分隔符是混乱的，CSV文件还存在一些其他的格式差异。比如是否使用双引号作为转义字符，是否默认CSV文件带有表头等等。这些差异组合排列可以产生数十种甚至上百种CSV方言。因此一个更有意思的事情发生了——有人专门制定了一个用于格式化描述CSV方言的标准。

我个人的建议是，在生成新的CSV文件时：

* 以RFC 4180标准作为基础。
* 使用LF（而非CRLF）表示换行。
* 生成新的CSV文件的时候，把RFC 4180中选填的表头当作必填项目。默认表格第一行是表头。

同时，为了减少转移序列带来的麻烦，应当尽量减少直接人工读写CSV文件。如果要修改CSV文件，最好借助Excel这种专门工具或者文本编辑器插件。

> 尽量减少直接人工独写CSV文件不是说不能直接人工独写CSV文件。而是说，不要不借助任何其他工具，直接用最基础的纯文本编辑器去读写CSV。

## 标准文件

这一小节列举一些关于CSV文件的格式信息。

首先，虽然不是标准文件，但是我强烈建议阅读的[Wikipedia: Comma-separated values](https://en.wikipedia.org/wiki/Comma-separated_values)。

然后是名义上的CSV标准，[RFC 4180 (CSV Standard)](https://tools.ietf.org/html/rfc4180)。

为了处理各种乱七八糟的CSV方言，我们也需要对于方言的统一描述，所以描述CSV方言的标准[CSV Dialect](https://frictionlessdata.io/specs/csv-dialect/)也是值得一读的。后边会说到描述CSV方言的用处。

## 人工读写CSV文件辅助工具

CSV文件的可读性不是非常好，因此要避免直接通过最基础的纯文本编辑器读写CSV文件。这里介绍一些用于读写CSV文件的工具。

### Visual Studio Code

主页：[Visual Studio Code](https://code.visualstudio.com/)

作用：文本编辑工具。

其实VS Code也就是一个好用一点的文本编辑器，它本身对于CSV文件的支持并不是很好。但它是后续插件的基础。

### Rainbow CSV

主页：[Rainbow CSV](https://marketplace.visualstudio.com/items?itemName=mechatroner.rainbow-csv)

作用：VS Code插件，辅助区分CSV文件各列，对CSV文件使用类SQL语法进行查询（RBQL），CSV Lint

注意：使用RBQL进行搜索时，如果要去掉作为表头的第一行，可以加上条件`WHERE HR>1`

这个插件最大的好处就是给每一列CSV文件染上不同颜色。并且当鼠标悬停于某个单元格上的时候还会显示这个单元格属于哪一列。顺便附赠一个用SQL风格语言对CSV文件进行查找的功能。

![使用Rainbow CSV的效果图](README.assets/1554347561359.png)

*图：使用Rainbow CSV的效果图*

### Excel Viewer

主页：[Excel Viewer](https://marketplace.visualstudio.com/items?itemName=GrapeCity.gc-excelviewer)

作用：VS Code插件，格式化浏览CSV文件，附带部分查询、过滤、排序功能

这个插件可以把CSV文件渲染为Excel中那样的表格来显示。

> 这个插件不仅能浏览CSV文件，也能用于浏览Excel文件。注意，仅限浏览，不能修改。

> 可能你注意到，**以上工具都不能解决浏览超大型CSV文件的问题**。这里我简单说一下我的看法。
>
> 首先，一个给人看的文件就不应该写得特别大（比如几十个M这种）。而应该按照逻辑分割成若干小文件，然后按照文件之间的逻辑关系组织起来。比如一个C写的程序就是由若干源码文件以及Makefile组成。
>
> 第二，不是给人看的文件，就应该用机器的方法处理。比如你要从几十万条数据里找一条错误的，然后修改。正确做法是使用流式编辑器搜索替换，而非用记事本打开这个文件然后人眼搜索。
>
> 第三，不是给人看的文件可以用程序提炼成给人看的文件。比如你要了解一个几十万行数据的表格的基本格式。你不需要把这个文件整个打开然后看。通过输出流导出这个文件的前几行作为一个单独的小文件，然后查看这个导出的文件就可以了。
>
> 综上，直接在VSCode，Vim，Emacs这类给人用的文本编辑器中打开超大文件，根本是一个思维混乱者提出的需求。

> 再说一点**关于Excel式使用体验**的问题。一个CSV编辑器当然可以做得像Excel那么好用。事实上，Excel就能编辑csv，VSCode中也有插件（叫做Edit csv）在模仿Excel。但我认为这些东西都已经和CSV本身离得太远。Excel提供的是编辑表格的功能，而CSV提供一种表格存储格式。使用体验好不好和表格用什么格式存储，没有很强的关系。因此这里我不打算介绍此类表格编辑工具。

## CSV解析工具

比较小的CSV文件还可以人工编辑。但是当CSV文件特别大的时候，人工编辑就变得十分繁琐。因此我们需要CSV解析工具。这类工具的作用就是把CSV格式的文件（或者字符串）转化为能够直接进行运算和处理的数据结构（比如链表，数组，矩阵）。与解析工具相对的，我们还需要或把运算和处理时所用的数据结构转化成CSV文件（或者CSV字符串）的工具。

这些工具有很多，而且不同平台，不同语言都有自己的CSV读写工具。我这里只介绍我比较熟悉的Python上常用的CSV工具。

### Python `csv` Module

主页：[Python `csv` Module](https://docs.python.org/3/library/csv.html)

作用：Python标准库模块，解析CSV文件，提供了描述CSV方言的`csv.Dialect`类（可以配合Pandas使用）

注意：

- `csv`模块可以解析多种CSV方言，也可以自己选择分隔符等。
- `csv`模块仅仅是CSV文件的解析工具（将字符串转化为列表和把列表转化为CSV格式的字符串你）， 不提供文件读取功能（需要配合Python中的`open`使用），也不提供表格查询、排序等功能。
- 通常，读取CSV文件后还要进行数据处理，因此直接使用Pandas读取CSV文件，然后进行处理更为方便。 一般不需要直接调用Python的`csv`模块。 但是在`csv`模块中定义的`Dialect`类可以用于给Pandas中`read_csv`函数的`dialect`参数赋值。

### Pandas

主页：[Pandas](https://pandas.pydata.org/)

作用：读取、解析、写入CSV文件

注意：

- Pandas可以解析多种CSV方言，也可以自己选择分隔符等。
- Pandas本身是用于数据分析的工具，拥有表格查询，排序等功能。 与数据存储结构CSV组合后相当于一个非常简易的的数据库解决方案。
- CSV本身没有预设的数据结构因此所有单元格都是字符串类型。 但是Pandas读取CSV文件后会试图为CSV中每一列设置一个数据类型。

用Pandas读取CSV文件的时候，默认自动推断换行符。所以一般来说不用设置这一个项目，也能获得正确的结果。不过为了保险起见，建议在调用函数时写明这一项。

---

[^1]: HT（Horizontal Tab），水平制表符。
[^2]:CR（Carriage Return），回车。
[^3]: LF（Line Feed），换行。





