# C#

必要前驱：

- [命令行工具](Chapter01.md)

## 最中规中矩的语言

C#（C Sharp）是一种倾向于面向对象编程范式的通用编程语言，在某些领域的直接竞争对手是Java和C++。C#在语法上十分类似Java和C++，但是整体设计更好，个人感觉使用起来更加舒服。此外C#不仅仅是一门语言，它所依托的dotnet生态还可以为它加分不少。接下来的很长一段时间中，我会简单介绍C#。

> 由于dotnet本身的流行程度不及Java，C#在现存各种项目中的占比远远不及Java。但是，最近几年微软拥抱社区，并且大力推进dotnet生态发展（我前两天在Github上看到了Tensorflow和Torch往dotnet上绑定的项目）。C#可能会有一定的发展。

## 面向过程

在具体介绍C#的语法之前，我们要先回顾一下编程范式。因为语法是在范式的基础上设计的。

对于C#而言，主要是按照面向过程和面向对象的范式设计的。兼采了一些其他范式做了局部的优化和改进。我们先从面向过程说起。

面向过程，就是精确地描述出程序执行的所有步骤。把整个过程详实地定义出来。这种方式和程序的定义是直接相关的。所以，写程序的时候这种范式是思维量最小的。如果已经有了算法伪代码或者步骤说明，接下来的大部分工作都是翻译而已。但是，将问题的解决方案完全转化成伪代码或者精确的步骤说明，本身却成了非常复杂和困难的工作。而且当程序的复杂度变大时，按照面向过程范式编写的程序也会变得越来越难以管理和维护。

不过我们暂且先不讨论面向过程的优劣，先来看看面向过程为C#带来了什么特性。

### 变量存储

面向过程，就要描述过程。而描述过程就要有时序先后。要有时序就要有变化。要体现变化就要保存状态以供对比。

因而要想面向过程编程，就要有状态存储的功能。这个功能具体到C#中就是变量的存储。简单来说，C#中的变量就是状态的存储器。变量的值，就是被存储的状态。我们用变量进行运算，给变量赋值，就是对状态的读取和修改。

在面向对象的程序中，我们所有的问题其实都是掌握一个状态，然后把这个状态变换成另一个状态。而变换的过程就是一个一个的“动作”。这些动作的序列就是我们写的程序。

> 面向过程和函数式中都有“变量”的概念。两者虽然一致，但是作用并不完全一样。面向过程中要考虑到时序的问题，变量归根结底是存储状态的。因而有一大套关于存储管理，变量创建，变量删除的机制。但是函数式编程中不关心这些。纯函数式编程中，变量仅仅是个占位符。

### 检测和改变

变量可以读也可以写。我们可以不顾一切地把所有变量都写一遍，这也算是一种程序。但是这种程序显然没有因地制宜，根据条件不同灵活变动的能力。为此我们还需要读变量。根据已有变量（已有状态）的不同，写入不同的内容。比如计算分段函数的函数值，我们要根据输入值的不同，选择不同的输出。

独写结合起来就能写出非常复杂的程序。只写不读是最简单的程序。那么只读不写呢？由于面向过程针对的是状态的变化。没有写就意味着状态没有发生任何改变。所以在程序中，相当于“时间”没有流逝。因此只写不读的程序，我们认为是没有意义的。因而程序中的“基本动作”，可以分为两类——不论之前条件如何，都尽心写操作的，以及根据之前条件不同执行不同写操作的。这两种操作还是太过于基础。C#经过层层打包封装，提供给我们很多更加好用的算符，内置函数，以及语句。具体到“根据当前条件选择执行不同的写操作”，这一部分功能，我们会介绍选择分支语句和循环语句。

> 选择分支和循环本质上都是条件跳转的应用。

> 面向过程会有状态，所以需要检测和改变状态。所以有选择分支语句和循环语句。而函数式中没有状态机制，所以理论上根本不需要这两种语句。
>
> 如果要用函数式编程实现选择分支和循环。普通做法是用条件表达式以及高阶函数`map`，`filter`，`reduce`。文艺做法是应用函数递归以及构造特殊函数。

### 过程代码的打包

之前说过，我们用若干“动作”组成程序。这些“动作”，可以分为两类。一类是已经实现了的，供我们直接使用的基本动作（比如给变量赋值，整数加减法等）。另一类则是我们通过组合基本动作而定义出来的复合的动作。为了方便后边的叙述，我们不妨把定义的复合动作称为“函数”（实际上在面向过程中，我更愿意称之为代码片段）。

我们的整个程序当然可以是直接用基本动作组合起来的一个大的复合动作。完成这整个动作之后状态就变成了我们想要的样子。基于这个思想，我们把动作当作一个函数。执行这个程序就相当于执行这个函数。于是有了我们上次Hello World程序中的写法。

```C#
using System;

namespace TX001
{
    class Program
    {
        static void Main(string[] args)
        {
            Console.WriteLine("Hello World!");
        }
    }
}
```

代码的其他部分我们还没有涉及到主要看`static void Main(string[] args)`及后边一对花括号种的内容。这一部分就是一个函数定义。这个函数叫做主函数，我们执行程序的时候就是在执行它。花括号中的内容是函数体。这里按顺序写下组成这个复合动作的若干子动作。

当程序步骤比较多的时候，把整个程序写成一个函数就不是很明智了。为了维护和编写方便。我们会预先把程序分成很多部分，每个部分都是函数。再把这些函数组装成更大的函数。程序更加复杂的时候，每个作为零件的函数又可以分为很多部分。

把整个程序拆分成若干小块还有一个好处。就是可能减少代码量。如果某两部分动作一样，那么把一样的部分打包成函数。在用到的地方调用这个函数就可以了 。不需要把同样的代码抄两次。看起来也更加整洁舒服。

这种把同一段代码在多个地方使用的方法叫做代码复用。谁都想用很少的代码办很多的事情。代码复用就是一个办法。很多编程范式中都有代码复用的办法，但是具体的实现是非常不同的。面向过程的代码复用是过程的复用。说白了就像《西游记后传》那样，只录制一段打斗视频。需要插打斗场面的时候就把这一段贴过去。

> 不同的范式中，“函数”的作用也是不太相同的。在面向过程中，函数主要是打包动作。函数的改变变量中存储的状态的副作用反而是主要的。而函数式中是不允许函数改变外部变量状态的。对于函数式中的函数，输入的参数和返回值是函数和外界唯一的交流方法。

## 面向对象

面向过程是C#支持的一种编程范式。但是现在这个年代你还想用纯面向过程完成大型软件，几乎是不可能完成的任务。因此C#虽然支持面向过程，但是它的设计者们压根没想让你用纯面向过程写程序。因此，仅仅知道面向过程还不够。我们需要再回顾一下面向对象。

C#的面向对象和C++，Java的面向对象实现方法类似。但是个人认为设计更加优雅，，不容易搞出各种乱七八糟的错误。

### 类是一种数据结构

讨论面向过程，面向过程，函数式等编程范式的时候。我认为都可以分两个层面来看。第一个层面是，基础思想，第二个层面是组织程序的思想。比如面向过程，基础思想就是一步一步把程序的步骤都规划出来。而当项目规模变大的时候，自然而然就要用上过程代码段的封装和重用。

面向对象编程的基本思想就是提出了一种新的打包数据的方法——类。这种数据结构像结构体一样可以把多种数据结构打包在一起形成一个整体。同时，可以把各种和类数据相关的方法（函数）打包进类里。另外类之间还可以有继承关系。我们不必每种类都亲自从头写到尾，可以基于已有的类构造新类。

> 面向对象是一种思想。就算语言中没有提供预定义的类构造方法。也可以通过其他手段构造出等价的数据结构来用。

> 面向对象范式中，代码重用主要是指通过继承方法构造类的时，可以重用父类的代码。面向对象的代码重用是类层面的重用，而不是描述过程的代码片段的重用。

### 用类组织程序

在程序组织层面应用面向对象，则是要通过类来组织起程序。我们不再需要把整个程序的全部步骤都亲自定义出来。如果用写剧本来类比的话。面向过程就是从头到尾把对话动作都想到然后全部写好。而面向对象更像是做人设，把每个人的性格和处事方式定义出来。具体演的时候，一堆人物聚在一起，根据各自的性格和处事方式行动。自然而然把故事演绎出来。

实际的应用中，支持面向对象的语言写出来的程序不一定都是用类来组织的。因为完全用类组织，就像把实际问题完全转化成一步一步的面向过程的算法一样，是需要很多工作的。因此，实际上很多程序在编写的时候仅仅用了面向对象的基本思想。也就是，用了类来管理程序中的数据。比如有的人写C++程序的时候大体上仍然用面向过程的方式管理，但是构造了很多类用于表示数据。这种写法也叫“C with class”。

### 过程和对象

经常会有人比较面向对象，面向过程编程的区别。但是它们并不是水火不容的。面向对象和面向过程其实是在处理不同领域的问题。

在通常使用的面向对象语言（C++/Java/C#/Python）中。我们可以用面向对象的方法组织程序的宏观结构和主体。但是每一个函数的内部，仍然采用面向过程的方法描述函数的运算过程。

